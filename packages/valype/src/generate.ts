import { parseAsync } from 'oxc-parser'

/**
 * convert TypeScript interface definitions to Zod schema
 * @param tsContent content of typeScript file
 * @returns generated Zod schema code as a string
 */
export async function generate(tsContent: string): Promise<string> {
  const ast = await parseAsync('temp.ts', tsContent)

  const interfaces: InterfaceInfo[] = []

  // iterate all top-level statements in the AST
  for (const stmt of ast.program.body) {
    // only handle export interface declaration statements
    if (
      stmt.type === 'ExportNamedDeclaration' &&
      stmt.declaration?.type === 'TSInterfaceDeclaration'
    ) {
      const name = stmt.declaration.id.name
      const properties: PropertyInfo[] = []

      // iterate all properties in the interface body
      for (const property of stmt.declaration.body.body) {
        // TODO only handle property signatures now
        if (property.type === 'TSPropertySignature') {
          const name = tsContent.slice(property.key.start, property.key.end)
          const type = property.typeAnnotation
            ? tsContent.slice(
                property.typeAnnotation.typeAnnotation.start,
                property.typeAnnotation.typeAnnotation.end,
              )
            : 'any'

          const isOptional = property.optional

          properties.push({
            name,
            type,
            isOptional,
          })
        }
      }

      interfaces.push({
        name,
        properties,
      })
    }
  }

  if (interfaces.length === 0) return ''
  let zodCode = `// generated by valype\nimport { z } from "zod/v4";\n\n`

  // convert each interface to Zod schema
  interfaces.forEach((intf) => {
    zodCode += `export const ${intf.name}Schema = z.object({\n`

    intf.properties.forEach((prop) => {
      const zodType = mapTypeToZod(prop.type)
      const zodField = prop.isOptional ? `${zodType}.optional()` : zodType
      zodCode += `  ${prop.name}: ${zodField},\n`
    })

    zodCode += `});\n\n`
  })

  return zodCode
}

interface InterfaceInfo {
  name: string
  properties: PropertyInfo[]
}

interface PropertyInfo {
  name: string
  type: string
  isOptional: boolean
}

/**
 * map TypeScript type to Zod schema type
 */
function mapTypeToZod(type: string): string {
  const typeLower = type.toLowerCase()

  // primitive
  if (typeLower === 'string') return 'z.string()'
  if (typeLower === 'number') return 'z.number()'
  if (typeLower === 'boolean') return 'z.boolean()'
  if (typeLower === 'date') return 'z.date()'

  // array
  if (type.endsWith('[]')) {
    const elementType = type.slice(0, -2)
    return `z.array(${mapTypeToZod(elementType)})`
  }

  // union
  if (type.includes('|')) {
    const types = type.split('|').map((t) => t.trim())
    return `z.union([${types.map((t) => mapTypeToZod(t)).join(', ')}])`
  }

  // literal
  if (type.match(/^".*"$/) || type.match(/^'.*'$/)) {
    return `z.literal(${type})`
  }

  // default to Zod object schema
  return `${type}Schema`
}
